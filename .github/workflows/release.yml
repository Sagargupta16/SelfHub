name: Release

on:
    push:
        tags:
            - "v*.*.*"

jobs:
    create-release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 9.0.0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build
              run: pnpm build

            - name: Get version from tag
              id: tag_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Create distribution package
              run: |
                  mkdir -p dist

                  # Create tarball with all necessary files
                  tar -czf dist/selfhub-mcp-server-${{ steps.tag_version.outputs.VERSION }}.tar.gz \
                    build/ \
                    package.json \
                    pnpm-lock.yaml \
                    README.md \
                    USAGE.md \
                    LICENSE

                  # Create zip file
                  zip -r dist/selfhub-mcp-server-${{ steps.tag_version.outputs.VERSION }}.zip \
                    build/ \
                    package.json \
                    pnpm-lock.yaml \
                    README.md \
                    USAGE.md \
                    LICENSE

            - name: Generate release notes
              run: |
                  cat > release_notes.md << 'EOF'
                  ## SelfHub MCP Server v${{ steps.tag_version.outputs.VERSION }}

                  ### ðŸš€ Features
                  - 9 MCP tools for memory and context management
                  - In-memory storage with pre-loaded sample data
                  - Full TypeScript implementation
                  - Ready for Claude Desktop and VS Code integration

                  ### ðŸ“¦ Installation

                  **Quick Start:**
                  ```bash
                  # Download and extract
                  tar -xzf selfhub-mcp-server-${{ steps.tag_version.outputs.VERSION }}.tar.gz
                  cd selfhub-mcp-server-${{ steps.tag_version.outputs.VERSION }}

                  # Install dependencies
                  pnpm install

                  # Build (if needed)
                  pnpm build
                  ```

                  **Configure in Claude Desktop:**
                  ```json
                  {
                    "mcpServers": {
                      "selfhub": {
                        "command": "node",
                        "args": ["/path/to/selfhub/build/index.js"]
                      }
                    }
                  }
                  ```

                  ### ðŸ“š Documentation
                  - See `README.md` for overview
                  - See `USAGE.md` for detailed usage instructions

                  ### ðŸ› ï¸ Tools Available
                  - **Memory:** store, retrieve, list, search, delete
                  - **Context:** create, activate, list
                  - **Analytics:** stats

                  ### âš¡ Requirements
                  - Node.js 18 or higher
                  - pnpm 9.0.0 or higher

                  EOF
                  cat release_notes.md

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      dist/*.tar.gz
                      dist/*.zip
                  body_path: release_notes.md
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
